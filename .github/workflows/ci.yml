name: test-build-delivery

env:
  APP_NAME: "verticals"
  PATH_TO_APPS: "~/apps"

on:
  push:
    branches: [ master ]

jobs:
  test_build_delivery:
    name: test, build and delivery bundle to server
    runs-on: ubuntu-18.04

    steps:
      - name: Clone repo ⚓️
        uses: actions/checkout@v2
        with:
          path: ${{ env.APP_NAME }}

      - name: Install 🔧
        working-directory: ${{ env.APP_NAME }}
        run: npm install

      - name: Lint 🧐
        working-directory: ${{ env.APP_NAME }}
        run: npm run lint

      - name: Test 🚨
        working-directory: ${{ env.APP_NAME }}
        run: npm run test

      - name: Regression check 👀
        working-directory: ${{ env.APP_NAME }}
        run: npm run loki:update

      - name: Setup .env 🧠
        working-directory: ${{ env.APP_NAME }}
        run: echo "${{ secrets.ENV_FILE }}" >> .env.production

      - name: Add commit hash to .env 🧠
        working-directory: ${{ env.APP_NAME }}
        run: echo "COMMIT_HASH=${{ github.sha }}" >> .env.production

      - name: Build 🔨
        working-directory: ${{ env.APP_NAME }}
        run: npm run build

      - name: Remove extra folders 🔨
        working-directory: ${{ env.APP_NAME }}
        run: rm -rf node_modules .loki story-book-static

      - name: Copy dist ✍️
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          source: ${{ env.APP_NAME }}
          target: ${{ env.PATH_TO_APPS }}

      - name: Start rerun script 😎
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: |
            cd ${{ env.PATH_TO_APPS }}/${{ env.APP_NAME }}
            chmod +x ./rerun.sh
            nohup ./rerun.sh > nohup.out 2> nohup.err < /dev/null &
